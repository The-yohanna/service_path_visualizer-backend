"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../index");
const string_incrementer_1 = require("./utils/string-incrementer");
function getNextIdString(field, idAssigner, fieldConfig, discriminatorName = '', retries = 1, getOnly = false) {
    return __awaiter(this, void 0, void 0, function* () {
        const nextId = fieldConfig.nextId;
        if (getOnly) {
            return nextId;
        }
        let afterNextId = fieldConfig.nextId;
        if (fieldConfig.nextIdFunction) {
            afterNextId = fieldConfig.nextIdFunction(nextId);
        }
        else {
            afterNextId = string_incrementer_1.stringIncrementer(nextId, fieldConfig.separator);
        }
        try {
            const updateField = discriminatorName
                ? `discriminators.${discriminatorName}.${field}.nextId`
                : `fields.${field}.nextId`;
            const update = yield idAssigner.collection.findOneAndUpdate({
                modelName: idAssigner.modelName,
                [updateField]: nextId,
            }, {
                $set: { [updateField]: afterNextId },
                $currentDate: { timestamp: true },
            }, { projection: { value: 1 } });
            if (update.ok && !update.value && retries < idAssigner.retryTime) {
                const multiplier = Math.abs(Math.random() * retries);
                yield index_1.waitPromise(idAssigner.retryMillis * multiplier);
                yield idAssigner.refreshOptions();
                return getNextIdString(field, idAssigner, fieldConfig, discriminatorName, ++retries);
            }
            else if (!update.value && retries > idAssigner.retryTime) {
                return Promise.reject(index_1.PluginError(`Maximum retryTime to set value attained!`, idAssigner.modelName, field));
            }
        }
        catch (e) {
            return Promise.reject(e);
        }
        return nextId;
    });
}
exports.getNextIdString = getNextIdString;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LW5leHQtaWQtc3RyaW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3V0aWxzL2dldC1uZXh0LWlkcy9nZXQtbmV4dC1pZC1zdHJpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFFQSxvQ0FBb0Q7QUFDcEQsbUVBQStEO0FBRS9ELFNBQXNCLGVBQWUsQ0FDbkMsS0FBYSxFQUNiLFVBQThCLEVBQzlCLFdBQThCLEVBQzlCLGlCQUFpQixHQUFHLEVBQUUsRUFDdEIsT0FBTyxHQUFHLENBQUMsRUFDWCxPQUFPLEdBQUcsS0FBSzs7UUFFZixNQUFNLE1BQU0sR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDO1FBRWxDLElBQUksT0FBTyxFQUFFO1lBQ1gsT0FBTyxNQUFNLENBQUM7U0FDZjtRQUVELElBQUksV0FBVyxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUM7UUFFckMsSUFBSSxXQUFXLENBQUMsY0FBYyxFQUFFO1lBQzlCLFdBQVcsR0FBRyxXQUFXLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ2xEO2FBQU07WUFDTCxXQUFXLEdBQUcsc0NBQWlCLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNoRTtRQUVELElBQUk7WUFDRixNQUFNLFdBQVcsR0FBRyxpQkFBaUI7Z0JBQ25DLENBQUMsQ0FBQyxrQkFBa0IsaUJBQWlCLElBQUksS0FBSyxTQUFTO2dCQUN2RCxDQUFDLENBQUMsVUFBVSxLQUFLLFNBQVMsQ0FBQztZQUM3QixNQUFNLE1BQU0sR0FBRyxNQUFNLFVBQVUsQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQ3pEO2dCQUNFLFNBQVMsRUFBRSxVQUFVLENBQUMsU0FBUztnQkFDL0IsQ0FBQyxXQUFXLENBQUMsRUFBRSxNQUFNO2FBQ3RCLEVBQ0Q7Z0JBQ0UsSUFBSSxFQUFFLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxXQUFXLEVBQUU7Z0JBQ3BDLFlBQVksRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUU7YUFDbEMsRUFDRCxFQUFFLFVBQVUsRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUM3QixDQUFDO1lBRUYsSUFBSSxNQUFNLENBQUMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxPQUFPLEdBQUcsVUFBVSxDQUFDLFNBQVMsRUFBRTtnQkFDaEUsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLENBQUM7Z0JBQ3JELE1BQU0sbUJBQVcsQ0FBQyxVQUFVLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQyxDQUFDO2dCQUN2RCxNQUFNLFVBQVUsQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQkFDbEMsT0FBTyxlQUFlLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsaUJBQWlCLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQzthQUN0RjtpQkFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxPQUFPLEdBQUcsVUFBVSxDQUFDLFNBQVMsRUFBRTtnQkFDMUQsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUNuQixtQkFBVyxDQUFDLDBDQUEwQyxFQUFFLFVBQVUsQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQ3JGLENBQUM7YUFDSDtTQUNGO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDMUI7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0NBQUE7QUFyREQsMENBcURDIn0=